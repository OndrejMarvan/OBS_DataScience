---
title: "USL Project 1: Global Energy Mix Regimes"
author: "Ondřej Marvan, 477001"
date: "`r Sys.Date()`"
output: html_document
---

# USL Project 1 

# List of Contents
1. Introduction
2. Data Preparation & Cleaning
3. Merging Research Data (GDP, CO2, Density)
4. Exploratory Data Analysis (EDA)
    - 4.1. Global Energy Evolution
    - 4.2. Correlation & Hypothesis Testing
5. Determining Optimal Clusters (Quality)
6. K-means Clustering Execution
7. Improving Clusters: Robustness & Taxonomy
    - 7.1. PAM Clustering 
    - 7.2. Hierarchical Dendrogram
8. Geographical Mapping
9. Profiling & Final Interpretation
10. Case Study: Czech Republic Progress & Cluster-Based Forecasting
    - 10.1. Energy Mix Evolution in Czechia (1990–2023)
    - 10.2. Forecasting Solar Transition via Cluster Logic
11. **NEW: Methodological Improvement - Single Year Clustering (2023)**

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

# Load required libraries
library(tidyverse)
library(cluster)      # For K-means and PAM
library(factoextra)   # For clustering visualizations
library(corrplot)     # For correlation matrices
library(maps)         # For world map data
```

# 1. Introduction

The objective of this project is to identify "Energy Regimes" by clustering countries based on their per-capita energy mix. I also investigated how these clusters relate to economic wealth (GDP), environmental impact (CO2), and physical constraints (Population Density). CO2 emissions and population density data are from the same source as energy data, while GDP data is sourced from the World Bank. All added additional data to create a more robust clustering model. Further, I decided to focus on Czech Republic as a further expansion of the project to analyze its energy transition and forecast future solar capacity using cluster-based logic.

# 2. Data Preparation & Cleaning

First, I load the primary energy dataset and filter for individual countries, removing regional aggregates (Europe, Asia, etc.).

```{r data_loading, include=TRUE}
energy_raw <- read.csv("per-capita-energy-stacked.csv", stringsAsFactors = FALSE)

# Filter for countries, replace NAs, and EXCLUDE ICELAND 
# (outlier that always creates its own cluster - 90% renewables from geothermal/hydro,
# unrealistic benchmark for other countries due to unique geography and small population)
energy_clean <- energy_raw %>%
  filter(Code != "" & !is.na(Code)) %>%
  filter(Entity != "Iceland") %>%
  mutate(across(4:11, ~replace_na(., 0))) %>%
  rename(
    Coal = coal_per_capita__kwh,
    Oil = oil_per_capita__kwh,
    Gas = gas_per_capita__kwh,
    Nuclear = nuclear_per_capita__kwh__equivalent,
    Hydropower = hydro_per_capita__kwh__equivalent,
    Wind = wind_per_capita__kwh__equivalent,
    Solar = solar_per_capita__kwh__equivalent,
    `Other renewables` = other_renewables_per_capita__kwh__equivalent
  )

# Define columns for clustering (consistent naming for later use)
energy_cols <- c("Coal", "Oil", "Gas", "Nuclear", "Hydropower", "Wind", "Solar", "Other renewables")

summary(energy_clean)
dim(energy_raw)   # raw data dimensions
dim(energy_clean) # cleaned data dimensions
```

We got 5865 values in 11 columns. Data are more or less ready for EDA.

# 3. Merging Research Data (GDP, CO2, Density)

Energy mix data looks good but quite boring to analyze them standalone, why not to add some socio-economic context? I downloaded GDP per capita, CO2 emissions per capita, and Population Density datasets from the same source as energy data (Our World in Data and World Bank). I merged them into a single "master_data" dataframe for further analysis.

```{r merge_research_data, include=TRUE}
gdp_data <- read.csv("gdp-per-capita-worldbank.csv")
co2_data <- read.csv("co2-emissions-per-capita.csv")
pop_data <- read.csv("population-density.csv")

# FIX: Changed from undefined 'energy_clean_renamed' to 'energy_clean'
master_data <- energy_clean %>%
  left_join(gdp_data %>% select(Entity, Code, Year, GDP = 4), 
            by = c("Entity", "Code", "Year")) %>%
  left_join(co2_data %>% select(Entity, Code, Year, CO2 = 4), 
            by = c("Entity", "Code", "Year")) %>%
  left_join(pop_data %>% select(Entity, Code, Year, Pop_Density = 4), 
            by = c("Entity", "Code", "Year"))

# Check merge results
cat("Master data dimensions:", dim(master_data), "\n")
cat("Missing GDP values:", sum(is.na(master_data$GDP)), "\n")
cat("Missing CO2 values:", sum(is.na(master_data$CO2)), "\n")
```

# 4. Exploratory Data Analysis (EDA)

## 4.1. Global Energy Evolution

Before clustering, we look at the historical trend of global energy consumption.

```{r global_energy_trend, include=TRUE}
# FIX: Color names now match energy_cols exactly
energy_colors <- c(
  Coal             = "#4D4D4D",
  Oil              = "#8B4513",
  Gas              = "#1F4E79",
  Nuclear          = "#73D06F",
  Hydropower       = "#1CA3EC",
  Wind             = "#A6CEE3",
  Solar            = "#FDB813",
  `Other renewables` = "#228B22"
)

master_data %>%
  group_by(Year) %>%
  summarise(across(all_of(energy_cols), mean, na.rm = TRUE)) %>%
  pivot_longer(-Year, names_to = "Source", values_to = "Usage") %>%
  ggplot(aes(x = Year, y = Usage, fill = Source)) +
  geom_area() +
  scale_fill_manual(values = energy_colors) +
  theme_minimal() +
  labs(
    title = "Global Average Energy Mix Evolution (1965–2023)",
    y = "kWh per capita",
    fill = "Energy Source"
  )
```

By analyzing the global energy mix from 1965 to the present, it's possible to observe that the total volume of energy used per person has grown significantly.

I noticed that while Solar and Wind have grown rapidly in recent years, they appear as a new layer being added on top of Fossil Fuels (Oil, Coal, and Gas). Even as countries innovate, our global dependence on traditional sources has not yet seen a major absolute decline, just a slight phase-out. This visual evidence suggests that the challenge for the countries I am clustering is not just 'getting cleaner,' but managing an ever-increasing appetite for energy as they grow wealthier.

Result above is taking into consideration demographic changes (per-capita basis). Below is displayed the absolute energy consumption growth (not per-capita).

![](Energy consumption by source, World.png)

For more in depth analysis of the current situation, check https://app.electricitymaps.com/map/.

## 4.2. Correlation & Hypothesis Testing

Hypothesis: Rich countries (high GDP) are the leaders in green energy.

```{r correlation_analysis, include=TRUE}
# Correlation Matrix
cor_vars <- c(energy_cols, "GDP", "CO2", "Pop_Density")
res_cor <- cor(master_data[, cor_vars], use = "complete.obs")
corrplot(res_cor, method = "color", type = "upper", addCoef.col = "black", number.cex = 0.6,
         tl.cex = 0.7, title = "Correlation Matrix: Energy Sources vs Socio-Economic Factors",
         mar = c(0, 0, 2, 0))
```

*Interpretation:* GDP correlates more strongly with Oil (0.71) than with Solar (0.26). This indicates that currently, wealth is a driver of total energy volume rather than just a green transition. This reflects the concept of "Energy Addition"—richer nations are adding renewables on top of, not instead of, fossil fuels. I need to remember I analyze data 1965-2024.

**NEW: Let's check if this relationship has changed over time:**

```{r correlation_over_time, include=TRUE}
# Check if GDP-Energy correlations have evolved
# Note: Early decades may have insufficient data, so we use a safe correlation function

safe_cor <- function(x, y) {
  # Returns NA if correlation can't be computed
  result <- tryCatch(
    cor(x, y, use = "complete.obs"),
    error = function(e) NA_real_
  )
  # Also return NA if too few observations
  complete_pairs <- sum(complete.cases(x, y))
  if (complete_pairs < 10) return(NA_real_)
  return(result)
}

cor_by_decade <- master_data %>%
  mutate(Decade = floor(Year / 10) * 10) %>%
  filter(Decade >= 1980) %>%  # Start from 1980 (better GDP coverage)
  group_by(Decade) %>%
  summarise(
    n_obs = n(),
    complete_gdp = sum(!is.na(GDP)),
    cor_gdp_oil = safe_cor(GDP, Oil),
    cor_gdp_solar = safe_cor(GDP, Solar),
    cor_gdp_wind = safe_cor(GDP, Wind),
    .groups = "drop"
  ) %>%
  filter(!is.na(cor_gdp_oil))  # Keep only decades with valid correlations

# Show data availability
cat("Data availability by decade:\n")
print(cor_by_decade %>% select(Decade, n_obs, complete_gdp))

# Plot correlations over time
cor_by_decade %>%
  select(Decade, cor_gdp_oil, cor_gdp_solar, cor_gdp_wind) %>%
  pivot_longer(-Decade, names_to = "Relationship", values_to = "Correlation") %>%
  mutate(Relationship = case_when(
    Relationship == "cor_gdp_oil" ~ "GDP-Oil",
    Relationship == "cor_gdp_solar" ~ "GDP-Solar",
    Relationship == "cor_gdp_wind" ~ "GDP-Wind"
  )) %>%
  ggplot(aes(x = Decade, y = Correlation, color = Relationship)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 3) +
  theme_minimal() +
  scale_x_continuous(breaks = seq(1980, 2020, 10)) +
  labs(title = "Evolution of GDP-Energy Correlations Over Time",
       subtitle = "Is the wealth-fossil fuel link weakening?",
       y = "Correlation Coefficient",
       x = "Decade")
```

**Key fixes:**
1. Created `safe_cor()` function that returns `NA` instead of throwing an error
2. Added minimum threshold of 10 complete pairs
3. Changed filter to start from **1980** (better GDP data coverage)
4. Added data availability check to show what's being used
5. Added `filter(!is.na(cor_gdp_oil))` to remove decades without valid correlations

This should run without errors now.

# 5. Determining Optimal Clusters (Quality)

We evaluate the energy variables only to find the "Natural Taxonomies" of energy use.

```{r optimal_clusters, include=TRUE}
energy_scaled <- scale(master_data[, energy_cols])

# FIX: Added set.seed() for reproducibility + nstart parameter
set.seed(123)
p1 <- fviz_nbclust(energy_scaled, kmeans, method = "wss", nstart = 25) + 
  labs(title = "Elbow Method") +
  theme_minimal()

set.seed(123)
p2 <- fviz_nbclust(energy_scaled, kmeans, method = "silhouette", nstart = 25) + 
  labs(title = "Silhouette Method") +
  theme_minimal()

# NEW: Add Gap Statistic
set.seed(123)
p3 <- fviz_nbclust(energy_scaled, kmeans, method = "gap_stat", nstart = 25, nboot = 50) + 
  labs(title = "Gap Statistic Method") +
  theme_minimal()

print(p1)
print(p2)
print(p3)
```

*Interpretation:* While Silhouette suggests k=2 (a simple Developed vs. Developing split), the Elbow method supports k=5. Following Classes, I choose k=5 to provide a more meaningful taxonomy, allowing us to distinguish between different high-income regimes (e.g., Oil-heavy vs. Green-heavy).

# 6. K-means Clustering Execution

```{r kmeans_execution, include=TRUE}
set.seed(123)
km_res <- kmeans(energy_scaled, centers = 5, nstart = 25, iter.max = 100)

# Assign cluster labels
master_data$Cluster_KM <- as.factor(km_res$cluster)

# Check cluster sizes
cat("K-means Cluster Sizes:\n")
print(table(master_data$Cluster_KM))

# Visualize K-means results
fviz_cluster(km_res, data = energy_scaled, geom = "point", 
             ellipse.type = "convex", palette = "Set1",
             main = "K-means Clustering Results (k=5)")
```

# 7. Improving Clusters: Robustness & Taxonomy

## 7.1. PAM Clustering

To handle outliers like Qatar or Kuwait, we run PAM (Partitioning Around Medoids). Unlike K-means, PAM uses actual data points as cluster centers (medoids), making it more robust to outliers.

```{r pam_clustering, include=TRUE}
# PAM (K-medoids) for robustness
set.seed(123)
pam_res <- pam(energy_scaled, k = 5)

# Assign PAM cluster labels (keeping both for comparison)
master_data$Cluster <- as.factor(pam_res$clustering)

cat("PAM Cluster Sizes:\n")
print(table(master_data$Cluster))

# NEW: Compare K-means vs PAM agreement
agreement_table <- table(KMeans = master_data$Cluster_KM, PAM = master_data$Cluster)
cat("\nK-means vs PAM Agreement Matrix:\n")
print(agreement_table)

agreement_rate <- sum(diag(agreement_table)) / sum(agreement_table)
cat("\nOverall Agreement Rate:", scales::percent(agreement_rate, accuracy = 0.1), "\n")
```

**NEW: Silhouette Analysis for PAM Validation**

```{r pam_silhouette, include=TRUE}
# Silhouette plot for PAM
sil <- silhouette(pam_res$clustering, dist(energy_scaled))
fviz_silhouette(sil) + 
  labs(title = "PAM Clustering: Silhouette Analysis",
       subtitle = "Values > 0.5 indicate good fit; < 0 suggests misclassification")

# Summary statistics
cat("\nAverage Silhouette Width:", round(mean(sil[, 3]), 3), "\n")
cat("Observations with negative silhouette (potentially misclassified):", sum(sil[, 3] < 0), "\n")
```

## 7.2. Hierarchical Dendrogram

The Dendrogram visualizes the hierarchical relationships between energy regimes.

```{r hierarchical_dendrogram, include=TRUE}
# Sample data for readable dendrogram (using most recent year)
set.seed(123)
recent_data <- master_data %>% filter(Year == 2022)
sample_idx <- sample(nrow(recent_data), min(80, nrow(recent_data)))
energy_sample <- scale(recent_data[sample_idx, energy_cols])
rownames(energy_sample) <- recent_data$Entity[sample_idx]

# Hierarchical clustering with Ward's method
hc <- hclust(dist(energy_sample), method = "ward.D2")

# Plot dendrogram
fviz_dend(hc, k = 5,
          cex = 0.5,
          palette = "Set1",
          rect = TRUE,
          rect_fill = TRUE,
          main = "Hierarchical Clustering Dendrogram (2022 Sample, n=80)",
          xlab = "Countries",
          ylab = "Height (Ward's Distance)")
```

*Interpretation:* The Dendrogram confirms the PAM structure, acting as a 'family tree' for energy strategies. It shows which countries have similar energy profiles and how different regimes relate to each other hierarchically.

**Cluster Interpretation (Based on PAM Medoids and Profiles):**

```{r cluster_interpretation, include=TRUE}
# Identify medoid countries (representative of each cluster)
recent_with_cluster <- master_data %>% filter(Year == 2022)

# Calculate cluster profiles
cluster_profiles <- recent_with_cluster %>%
  group_by(Cluster) %>%
  summarise(
    n_countries = n(),
    across(all_of(energy_cols), mean, na.rm = TRUE),
    Avg_GDP = mean(GDP, na.rm = TRUE),
    Avg_CO2 = mean(CO2, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  arrange(desc(Avg_GDP))

print(cluster_profiles)

# Visual profile comparison
cluster_profiles %>%
  select(Cluster, all_of(energy_cols)) %>%
  pivot_longer(-Cluster, names_to = "Source", values_to = "Value") %>%
  ggplot(aes(x = Source, y = Value, fill = Cluster)) +
  geom_bar(stat = "identity", position = "dodge") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "Energy Mix Profile by Cluster",
       y = "Mean kWh per capita")
```

# 8. Geographical Mapping

I visualize the distribution of our 5 clusters across the world and zoom in on specific regions.

```{r map_data_preparation, include=TRUE}
# Prepare map data (do this ONCE, then reuse)
world_coords <- map_data("world")

map_ready_data <- master_data %>%
  filter(Year == 2022) %>%
  mutate(region = case_when(
    Entity == "Czechia" ~ "Czech Republic",
    Entity == "United States" ~ "USA",
    Entity == "United Kingdom" ~ "UK",
    Entity == "Democratic Republic of Congo" ~ "Democratic Republic of the Congo",
    Entity == "Congo" ~ "Republic of Congo",
    Entity == "Cote d'Ivoire" ~ "Ivory Coast",
    TRUE ~ Entity
  ))

map_joined <- world_coords %>%
  left_join(map_ready_data, by = "region")

# Check mapping success
cat("Countries successfully mapped:", 
    n_distinct(map_ready_data$region[map_ready_data$region %in% world_coords$region]), "\n")
```

```{r map_world, include=TRUE}
# World Map
ggplot(map_joined, aes(x = long, y = lat, group = group, fill = Cluster)) +
  geom_polygon(color = "white", linewidth = 0.1) +
  scale_fill_brewer(palette = "Set1", na.value = "grey90") +
  theme_minimal() +
  labs(title = "Global Energy Regimes (2022)",
       subtitle = "5 clusters identified by per-capita energy mix",
       fill = "Cluster") +
  theme(axis.text = element_blank(), 
        axis.title = element_blank(), 
        panel.grid = element_blank())
```

```{r map_europe, include=TRUE}
# Europe Focus Map
ggplot(map_joined, aes(x = long, y = lat, group = group, fill = Cluster)) +
  geom_polygon(color = "white", linewidth = 0.1) +
  coord_fixed(xlim = c(-25, 45), ylim = c(34, 71), ratio = 1.3) +
  scale_fill_brewer(palette = "Set1", na.value = "grey90") +
  theme_minimal() +
  labs(title = "Energy Regimes: Europe Focus (2022)", 
       fill = "Cluster") +
  theme(axis.text = element_blank(), 
        axis.title = element_blank(), 
        panel.grid = element_blank())
```

*Interpretation:* The global map reveals clear regional patterns in energy strategies. Western Europe shows more diversified energy portfolios, while Eastern Europe has different patterns. Northern Africa and the Middle East show high fossil fuel consumption, while Sub-Saharan Africa is largely characterized by low overall energy consumption.

# 9. Profiling & Final Interpretation

To conclude, we look at the average socio-economic profile of each cluster.

```{r cluster_profiling, include=TRUE}
profile_summary <- master_data %>%
  filter(Year == 2022) %>%
  group_by(Cluster) %>%
  summarise(
    N_Countries = n(),
    Avg_GDP = round(mean(GDP, na.rm = TRUE), 0),
    Avg_CO2 = round(mean(CO2, na.rm = TRUE), 2),
    Avg_Total_Energy = round(mean(Coal + Oil + Gas + Nuclear + Hydropower + Wind + Solar, na.rm = TRUE), 0),
    Avg_Solar = round(mean(Solar, na.rm = TRUE), 0),
    Avg_Wind = round(mean(Wind, na.rm = TRUE), 0),
    Avg_Oil = round(mean(Oil, na.rm = TRUE), 0),
    Avg_Coal = round(mean(Coal, na.rm = TRUE), 0),
    .groups = "drop"
  ) %>%
  arrange(desc(Avg_GDP))

knitr::kable(profile_summary, caption = "Cluster Profiles: Socio-Economic and Energy Characteristics (2022)")
```

The data reveals an 'Energy Addition' paradox. While wealth (GDP) provides the capital for Solar investment, it is more strongly linked to high-volume Oil and Gas consumption. This suggests that as countries get richer, they tend to add renewables on top of fossil fuels rather than immediately replacing them. Clustering successfully separates different energy regime types based on their dominant sources and consumption levels.

# 10. Case Study: Czech Republic Progress & Cluster-Based Forecasting

In this section, I apply the theory from last clustering clas (forecasting): using cluster membership to develop an aggregated forecast that reduces variance and potentially lowers the Mean Square Error (MSE) compared to a single-country model.

## 10.1. Energy Mix Evolution in Czechia (1990–2023)

Firsty, I visualize the progress of Czechia's energy sources. This chart shows the "decoupling" process (or lack thereof) from fossil fuels.

```{r czechia_energy_mix, include=TRUE}
czechia_progress <- master_data %>%
  filter(Entity == "Czechia" & Year >= 1990) %>%
  pivot_longer(cols = all_of(energy_cols), names_to = "Source", values_to = "Usage")

ggplot(czechia_progress, aes(x = Year, y = Usage, fill = Source)) +
  geom_area(alpha = 0.85) +
  theme_minimal() +
  scale_fill_manual(values = energy_colors) +
  labs(title = "Czech Republic: Energy Source Progress (1990-2023)",
       subtitle = "Per-capita energy consumption by source",
       y = "kWh per capita", x = "Year")
```

*Interpretation:* Czechia shows a strong historical reliance on Coal and Nuclear. While Solar and Wind (at the top) are growing, they still represent a small "wedge" compared to the industrial baseload provided by traditional sources.

## 10.2. Forecasting Solar Transition via Cluster Logic

Instead of just looking at Czechia's past, we use the "Aggregated Forecast" method. We identify Czechia's cluster and use the cluster's average growth rate to predict Czechia's 2030 solar capacity.

```{r czechia_forecasting, include=TRUE}
# FIX: Use the most recent available year dynamically
max_year <- max(master_data$Year[master_data$Entity == "Czechia"], na.rm = TRUE)
cat("Most recent year for Czechia:", max_year, "\n")

cze_latest <- master_data %>% filter(Entity == "Czechia" & Year == max_year)

# Error handling
if (nrow(cze_latest) == 0) {
  stop("No data found for Czechia in the specified year")
}

target_cluster <- cze_latest$Cluster
cat("Czechia belongs to Cluster:", as.character(target_cluster), "\n")

# FIX: Added arrange(Year) to ensure chronological order for first()/last()
cluster_solar_growth <- master_data %>%
  filter(Cluster == target_cluster & Year >= 2012) %>%
  group_by(Entity) %>%
  arrange(Year) %>%  # CRITICAL: Ensure chronological order
  summarise(
    start_solar = first(Solar),
    end_solar = last(Solar),
    start_year = first(Year),
    end_year = last(Year),
    growth_rate = (end_solar - start_solar) / (end_year - start_year),
    .groups = "drop"
  ) %>%
  filter(is.finite(growth_rate)) %>%
  summarise(
    avg_cluster_growth = mean(growth_rate, na.rm = TRUE),
    sd_cluster_growth = sd(growth_rate, na.rm = TRUE),
    n_countries = n()
  )

cat("\nCluster Solar Growth Statistics:\n")
cat("Average annual growth:", round(cluster_solar_growth$avg_cluster_growth, 1), "kWh/capita/year\n")
cat("Std deviation:", round(cluster_solar_growth$sd_cluster_growth, 1), "\n")
cat("Based on", cluster_solar_growth$n_countries, "countries\n")

# Apply growth rate to forecast
current_solar <- cze_latest$Solar
forecast_years <- 2030 - max_year

projected_solar_2030 <- current_solar + (cluster_solar_growth$avg_cluster_growth * forecast_years)
projected_solar_low <- current_solar + ((cluster_solar_growth$avg_cluster_growth - cluster_solar_growth$sd_cluster_growth) * forecast_years)
projected_solar_high <- current_solar + ((cluster_solar_growth$avg_cluster_growth + cluster_solar_growth$sd_cluster_growth) * forecast_years)

# Create forecast visualization with confidence band
forecast_data <- data.frame(
  Year = c(max_year, 2030),
  Solar = c(current_solar, projected_solar_2030),
  Solar_Low = c(current_solar, projected_solar_low),
  Solar_High = c(current_solar, projected_solar_high),
  Label = c(paste0("Current (", max_year, ")"), "Forecast (2030)")
)

ggplot(forecast_data, aes(x = Year, y = Solar)) +
  geom_ribbon(aes(ymin = Solar_Low, ymax = Solar_High), fill = "lightblue", alpha = 0.5) +
  geom_line(linetype = "dashed", color = "darkblue", linewidth = 1) +
  geom_point(aes(color = Label), size = 5) +
  theme_minimal() +
  scale_color_manual(values = c("darkblue", "red")) +
  ylim(0, max(projected_solar_high, na.rm = TRUE) * 1.2) +
  labs(title = "Czechia 2030 Solar Forecast (Cluster-Based)",
       subtitle = paste("Based on the trajectory of Cluster", target_cluster, 
                        "| Shaded area = ±1 SD"),
       y = "Solar kWh per capita",
       color = "")
```

*Conclusion:* If the Czech Republic maintains the adoption speed typical of its cluster, it will reach approximately `r round(projected_solar_2030, 0)` kWh per capita in solar energy by 2030. This provides a data-driven benchmark for national energy goals.

---

# 11. Methodological Improvement: Single Year Clustering (2023)

## Why the Original Approach is Problematic

**The original analysis clustered ALL country-year observations from 1965-2023 together.** This approach has several significant methodological issues:

1. **Temporal Mixing**: Germany in 1970 and Germany in 2020 are treated as completely separate observations. This means the same country appears multiple times with different energy profiles.

2. **Inflated Sample Size**: We have ~5,800 observations, but many are the same ~150 countries across 60 years. This gives a false sense of statistical power.

3. **Cluster Instability**: A country can belong to different clusters in different years (which we don't leverage), making interpretation confusing.

4. **Historical Averaging**: Cluster profiles average across 60 years of dramatic energy transitions, diluting meaningful current patterns.

**Better approach: Snapshot Clustering** - Cluster countries based on their **current** (2023 or most recent) energy mix to identify today's energy regimes.

```{r single_year_rationale, include=TRUE}
# Demonstrate the problem: How many times does each country appear?
country_freq <- master_data %>%
  group_by(Entity) %>%
  summarise(n_years = n(), .groups = "drop")

cat("Total observations in original clustering:", nrow(master_data), "\n")
cat("Unique countries:", n_distinct(master_data$Entity), "\n")
cat("Average years per country:", round(mean(country_freq$n_years), 1), "\n")

# Show how Czechia's energy mix changed over time
czechia_evolution <- master_data %>%
  filter(Entity == "Czechia" & Year %in% c(1990, 2000, 2010, 2020)) %>%
  select(Year, Coal, Oil, Gas, Nuclear, Solar, Wind)

knitr::kable(czechia_evolution, caption = "Czechia's Energy Mix Evolution (selected years)")
```

## Single-Year Clustering (2023)

Now we perform clustering on the most recent year only, providing a cleaner snapshot of current energy regimes.

```{r single_year_clustering, include=TRUE}
# Get most recent year with good data coverage
max_available_year <- max(master_data$Year)
cat("Clustering year:", max_available_year, "\n")

# Filter for single year
data_2023 <- master_data %>%
  filter(Year == max_available_year) %>%
  filter(complete.cases(.[, energy_cols]))  # Remove rows with missing energy data

cat("Countries available for clustering:", nrow(data_2023), "\n")

# Scale energy data
energy_scaled_2023 <- scale(data_2023[, energy_cols])
rownames(energy_scaled_2023) <- data_2023$Entity
```

### Optimal k for Single-Year Data

```{r optimal_k_2023, include=TRUE}
set.seed(123)
p1_2023 <- fviz_nbclust(energy_scaled_2023, pam, method = "wss") + 
  labs(title = "Elbow Method (2023 Data Only)") +
  theme_minimal()

set.seed(123)
p2_2023 <- fviz_nbclust(energy_scaled_2023, pam, method = "silhouette") + 
  labs(title = "Silhouette Method (2023 Data Only)") +
  theme_minimal()

print(p1_2023)
print(p2_2023)
```

### PAM Clustering on 2023 Data

```{r pam_2023, include=TRUE}
set.seed(123)
pam_2023 <- pam(energy_scaled_2023, k = 5)

data_2023$Cluster_2023 <- as.factor(pam_2023$clustering)

# Cluster sizes
cat("\nCluster Sizes (2023 Snapshot):\n")
print(table(data_2023$Cluster_2023))

# Silhouette validation
sil_2023 <- silhouette(pam_2023$clustering, dist(energy_scaled_2023))
cat("\nAverage Silhouette Width:", round(mean(sil_2023[, 3]), 3), "\n")

fviz_silhouette(sil_2023) + 
  labs(title = "PAM Silhouette Analysis (2023 Snapshot)",
       subtitle = "Single-year clustering provides cleaner separation")
```

### Cluster Profiles (2023)

```{r profiles_2023, include=TRUE}
# Identify medoid countries (actual representative countries)
medoid_countries <- data_2023$Entity[pam_2023$id.med]
cat("\nMedoid Countries (Cluster Representatives):\n")
for (i in 1:5) {
  cat("Cluster", i, ":", medoid_countries[i], "\n")
}

# Detailed cluster profiles
profiles_2023 <- data_2023 %>%
  group_by(Cluster_2023) %>%
  summarise(
    N = n(),
    Medoid = medoid_countries[as.numeric(unique(Cluster_2023))],
    Avg_GDP = round(mean(GDP, na.rm = TRUE), 0),
    Avg_CO2 = round(mean(CO2, na.rm = TRUE), 1),
    Coal = round(mean(Coal), 0),
    Oil = round(mean(Oil), 0),
    Gas = round(mean(Gas), 0),
    Nuclear = round(mean(Nuclear), 0),
    Hydropower = round(mean(Hydropower), 0),
    Solar = round(mean(Solar), 0),
    Wind = round(mean(Wind), 0),
    .groups = "drop"
  )

knitr::kable(profiles_2023, caption = "Cluster Profiles: 2023 Snapshot")
```

### Visualization: 2023 Clusters

```{r viz_2023, include=TRUE}
# PCA visualization
fviz_cluster(pam_2023, data = energy_scaled_2023, 
             geom = "point",
             ellipse.type = "convex",
             palette = "Set1",
             main = "Energy Regimes (2023 Snapshot)",
             ggtheme = theme_minimal())

# Radar-style comparison (bar chart alternative)
profiles_2023 %>%
  select(Cluster_2023, Coal, Oil, Gas, Nuclear, Hydropower, Solar, Wind) %>%
  pivot_longer(-Cluster_2023, names_to = "Source", values_to = "kWh") %>%
  ggplot(aes(x = Source, y = kWh, fill = Cluster_2023)) +
  geom_bar(stat = "identity", position = "dodge") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "Energy Mix by Cluster (2023)",
       y = "Mean kWh per capita",
       fill = "Cluster")
```

### Where is Czechia in 2023?

```{r czechia_2023, include=TRUE}
czechia_2023 <- data_2023 %>% filter(Entity == "Czechia")

cat("Czechia's Cluster (2023):", as.character(czechia_2023$Cluster_2023), "\n")
cat("Medoid of this cluster:", medoid_countries[as.numeric(czechia_2023$Cluster_2023)], "\n")

# List cluster peers
cluster_peers <- data_2023 %>%
  filter(Cluster_2023 == czechia_2023$Cluster_2023) %>%
  arrange(desc(GDP)) %>%
  select(Entity, GDP, Coal, Nuclear, Solar, Wind)

cat("\nCzechia's Cluster Peers (sorted by GDP):\n")
print(head(cluster_peers, 15))
```

### Key Insight: Single-Year vs Multi-Year Comparison

```{r comparison, include=TRUE}
# Compare silhouette scores
cat("Methodological Comparison:\n")
cat("=========================\n")
cat("Multi-year clustering (1965-2023):\n")
cat("  - Observations:", nrow(master_data), "\n")
cat("  - Avg Silhouette:", round(mean(sil[, 3]), 3), "\n\n")

cat("Single-year clustering (2023):\n")
cat("  - Observations:", nrow(data_2023), "\n")
cat("  - Avg Silhouette:", round(mean(sil_2023[, 3]), 3), "\n\n")

cat("Interpretation: Single-year clustering typically provides better silhouette scores\n")
cat("because it clusters current comparable states, not historical trajectories.\n")
```

## Conclusion

The **single-year (2023) clustering** provides cleaner, more interpretable results because:

1. Each country appears exactly **once** - no temporal mixing
2. Clusters represent **current** energy regimes, not historical averages
3. **Silhouette scores** are typically higher (better cluster separation)
4. Results directly inform **current policy discussions**

The original multi-year approach is still valuable for **tracking cluster transitions over time** (trajectory analysis), but for identifying current energy regimes, snapshot clustering is methodologically superior.

---

*End of Report*
