---
title: '#USL_P1_477001'
output: html_document
date: "2025-12-20"
---
# USL Project 1 
Expected output is to do a choose athe most suitable clustering method, do the cluestering and then forecasting. 

```{r libraries, include=FALSE}
# Install missing libraries on local machine
# install.packages("NbClust")
# Load other necessary and already installed libraries
library(tidyverse)
library(cluster)     # For clustering algorithms
library(factoextra)  # For beautiful clustering plots
library(corrplot)    # For correlation matrices
library(NbClust)     # For optimal k calculation
```

# 1. Introduction
The goal of this project is to cluster countries based on their per-capita energy consumption mix. Unlike a static snapshot, we are using the full dataset (all years) to identify "Energy Regimes" that countries have passed through or are currently in.


# 2. Data Preparation & Cleaning
First, we load the data and remove regional aggregates. We only want individual countries (those with an ISO Code).

```{r load data, include=TRUE}
# Load the raw data
energy_raw <- read.csv("per-capita-energy-stacked.csv", stringsAsFactors = FALSE)

# 1. Filter: Keep only countries (where Code is not empty)
energy_clean <- energy_raw %>%
  filter(Code != "" & !is.na(Code))

# 2. Define the energy source columns and rename them for easier reference
energy_cols <- c("coal_per_capita__kwh", "oil_per_capita__kwh", "gas_per_capita__kwh", 
                 "nuclear_per_capita__kwh__equivalent", "hydro_per_capita__kwh__equivalent", 
                 "wind_per_capita__kwh__equivalent", "solar_per_capita__kwh__equivalent", 
                 "other_renewables_per_capita__kwh__equivalent")
energy_cols_renamed <- c(
  "Coal", "Oil", "Gas", "Nuclear",
  "Hydropower", "Wind", "Solar", "Other renewables"
)

# 3. Handle Missing Values: Replace NA with 0
# Logic: If a source is missing for a country in 1970, consumption was likely zero.
energy_clean <- energy_clean %>%
  mutate(across(all_of(energy_cols), ~replace_na(., 0)))

# 4. Rename the columns for easier reference
energy_clean_renamed <- energy_clean %>%
  rename(
    Coal = coal_per_capita__kwh,
    Oil = oil_per_capita__kwh,
    Gas = gas_per_capita__kwh,
    Nuclear = nuclear_per_capita__kwh__equivalent,
    Hydropower = hydro_per_capita__kwh__equivalent,
    Wind = wind_per_capita__kwh__equivalent,
    Solar = solar_per_capita__kwh__equivalent,
    `Other renewables` = other_renewables_per_capita__kwh__equivalent
  )

dim(energy_raw) # 6585   11, includes whole continents and regions
dim(energy_clean_renamed) # 5925 values/cells   11 columns (only countries)

```
We got 5925 values in 11 columns. Data are more or less ready for EDA. 


# 3. Massive Exploratory Data Analysis (EDA)
## 3.1. Global Energy Development Over Time
To justify clustering all years, we look at how the average global energy mix has evolved.

```{r EDA, include=TRUE}
global_trend <- energy_clean_renamed %>%
  group_by(Year) %>%
  summarise(across(all_of(energy_cols_renamed), mean)) %>%
  pivot_longer(-Year, names_to = "Source", values_to = "Usage")

ggplot(global_trend, aes(x = Year, y = Usage, fill = Source)) +
  geom_area(alpha = 0.8) +
  theme_minimal() +
  scale_fill_brewer(palette = "Set3") +
  labs(title = "Evolution of Global Average Energy Mix (1965-2024)",
       subtitle = "Average per capita consumption across all countries",
       y = "kWh per capita", x = "Year")

```
*Interpretation:* The global energy mix has changed significantly over the decades, with fossil fuels dominating until recent years when renewables started to gain traction. Sure visible phase-out of coal and replacement by gas, nuclear and renewables. We face a slight downward trend in energy consumption per capita in the last decade, possibly due to efficiency improvements and slight deindustrialization in some regions (USA, Europe).

General result to see how looks the total energy consumption per capita by source over time. Similar to the total Energy consumption by source visualized below and accessible here: https://ourworldindata.org/energy-mix. 

```{r total energy consumption image}
knitr::include_graphics("Energy consumption by source, World.png")

# Link: https://ourworldindata.org/energy-mix
```


*Interpretation:* We see a massive growth in Fossil Fuels (Oil, Gas, Coal) until the early 2000s, followed by the visible "wedge" of Renewables (Wind, Solar) appearing in the last decade.

## 3.2. Distribution and Outliers
Energy consumption is highly unequal. We use boxplots to see the "spread" of each source.

```{R outliers, inlude=TRUE}
energy_clean_renamed %>%
  select(all_of(energy_cols_renamed)) %>%
  pivot_longer(cols = everything(), names_to = "Source", values_to = "Value") %>%
  ggplot(aes(x = Source, y = Value, fill = Source)) +
  geom_boxplot() +
  coord_flip() +
  theme_minimal() +
  theme(legend.position = "none") +
  labs(title = "Distribution of Energy Sources", subtitle = "Extreme outliers in Fossil Fuels")
```

## 3.3. Correlation Matrix
We check if any energy sources are "linked." For example, do countries that use a lot of Gas also use a lot of Oil?

Are fossil sources of energy correlated to each other? Are renewable sources correlated to each other? Indeed, at least a bit. 

```{r correlation matrix, include=TRUE}
cor_matrix <- cor(energy_clean_renamed[, energy_cols_renamed])
corrplot(cor_matrix, method = "color", type = "upper", addCoef.col = "black", 
         tl.col = "black", tl.srt = 45, number.cex = 0.7)
```

*Interpretation:* There are moderate positive correlations among fossil fuels (Coal, Oil, Gas) and among renewables (Wind, Solar, Other renewables). Nuclear and Hydropower show weaker correlations with other sources.

## 3.4 Further Correlation Analysis
```{r further correlation analysis, include=TRUE}
# 1. Load the extra research data
gdp_data <- read.csv("gdp-per-capita-worldbank.csv", stringsAsFactors = FALSE)
co2_data <- read.csv("co2-emissions-per-capita.csv", stringsAsFactors = FALSE)
pop_data <- read.csv("population-density.csv", stringsAsFactors = FALSE)

# 2. Join the data together using Entity, Code, and Year as the "link"
# We use left_join so we keep all our energy records
energy_research <- energy_clean_renamed %>%
  left_join(gdp_data %>% select(Entity, Code, Year, GDP = 4), by = c("Entity", "Code", "Year")) %>%
  left_join(co2_data %>% select(Entity, Code, Year, CO2 = 4), by = c("Entity", "Code", "Year")) %>%
  left_join(pop_data %>% select(Entity, Code, Year, Pop_Density = 4), by = c("Entity", "Code", "Year"))

# 3. Check Correlation
# We select our energy types + the 3 new research metrics
cor_vars <- c("Coal", "Oil", "Gas", "Nuclear", "Hydropower", "Wind", "Solar", 
              "Other renewables", "GDP", "CO2", "Pop_Density")

# We calculate the correlation, using 'complete.obs' to handle missing GDP/CO2 values
research_cor <- cor(energy_research[, cor_vars], use = "complete.obs")

# Visualize the correlation matrix
library(corrplot)
corrplot(research_cor, method = "circle", type = "upper", 
         tl.col = "black", tl.srt = 45, addCoef.col = "black", number.cex = 0.7)
```


Data shows that wealth (GDP) is more strongly linked to fossil fuel consumption (Oil/Gas) than to renewables since I analyze data from 1965 and green transition started no earlier than Kyoto protocol establishment in 1998 and its further application that started in 2000s. This suggests that high income does not automatically lead to a green energy mix; rather, it leads to higher overall energy demand.

Based on the mixed results from the last correlation matrix, I decided not to move forward with GDP, CO2, and Population Density, at least not in the initial phase of clustering. 

# 4. Finding the Optimal Number of Clusters (k)

Before running the final model, we must check if our choice of 5 clusters is supported by the data using the methods from **Class 04**.

```{r optimal_k_analysis}
# 1. RE-ESTABLISH DATA (Ensuring master_data is available)
gdp_raw  <- read.csv("gdp-per-capita-worldbank.csv")
co2_raw  <- read.csv("co2-emissions-per-capita.csv")
pop_raw  <- read.csv("population-density.csv")

master_data <- energy_clean_renamed %>%
  left_join(gdp_raw %>% select(Entity, Code, Year, GDP = 4), by = c("Entity", "Code", "Year")) %>%
  left_join(co2_raw %>% select(Entity, Code, Year, CO2 = 4), by = c("Entity", "Code", "Year")) %>%
  left_join(pop_raw %>% select(Entity, Code, Year, Pop_Density = 4), by = c("Entity", "Code", "Year"))

# 2. SELECT ENERGY COLUMNS FOR CLUSTERING
# We cluster ONLY on energy mix to find "Energy Regimes"
energy_only_scaled <- master_data %>%
  select(Coal, Oil, Gas, Nuclear, Hydropower, Wind, Solar, `Other renewables`) %>%
  scale()

# 3. ELBOW METHOD

fviz_nbclust(energy_only_scaled, kmeans, method = "wss") +
  geom_vline(xintercept = 5, linetype = 2, color = "red") +
  labs(title = "Elbow Method: Energy Mix Clusters")

# 4. SILHOUETTE METHOD

fviz_nbclust(energy_only_scaled, kmeans, method = "silhouette") +
  labs(title = "Silhouette Method: Energy Mix Clusters")
```

*Interpretation:* While the Silhouette method suggests that the most distinct mathematical split is into two groups (likely representing the global energy-wealth gap), the Elbow method suggests an optimal k=5. I have chosen k=5 for this research because it provides a more granular taxonomy. This allows us to distinguish between different high-energy profiles (e.g., Fossil-heavy vs. Renewable-heavy), which is essential for our forecasting goals.

Well, lets involve our other metries (GDP, CO2, Population Density) and see if the optimal k changes.

## 4.1 Checking if k Changes with Socio-Economic Metrics

We will now merge the data and run the Elbow and Silhouette methods on the combined feature set (8 Energy sources + GDP + CO2 + Density).

```{r research_k_check}
# 1. RE-CREATE MASTER DATA (To fix the 'object not found' error)
gdp_raw  <- read.csv("gdp-per-capita-worldbank.csv")
co2_raw  <- read.csv("co2-emissions-per-capita.csv")
pop_raw  <- read.csv("population-density.csv")

master_data <- energy_clean_renamed %>%
  left_join(gdp_raw %>% select(Entity, Code, Year, GDP = 4), by = c("Entity", "Code", "Year")) %>%
  left_join(co2_raw %>% select(Entity, Code, Year, CO2 = 4), by = c("Entity", "Code", "Year")) %>%
  left_join(pop_raw %>% select(Entity, Code, Year, Pop_Density = 4), by = c("Entity", "Code", "Year"))

# 2. PREPARE DATA FOR CLUSTERING
# We use drop_na() because clustering cannot handle missing values
clustering_data_scaled <- master_data %>%
  drop_na(GDP, CO2, Pop_Density) %>%
  select(Coal, Oil, Gas, Nuclear, Hydropower, Wind, Solar, `Other renewables`, GDP, CO2, Pop_Density) %>%
  scale()

# 3. ELBOW METHOD
# We look for the "bend" in the arm to justify k=5

fviz_nbclust(clustering_data_scaled, kmeans, method = "wss") +
  geom_vline(xintercept = 5, linetype = 2, color = "red") +
  labs(title = "Elbow Method: Socio-Economic Energy Profiles")

# 4. SILHOUETTE METHOD

fviz_nbclust(clustering_data_scaled, kmeans, method = "silhouette") +
  labs(title = "Silhouette Method: Socio-Economic Energy Profiles")
```   
*Interpretation:* The Elbow method still suggests k=5, while the Silhouette method again points to k=2. This reinforces my earlier decision to use k=5 for a more detailed taxonomy, even when considering socio-economic factors.

# 5.0 Running K-Means and Visualization
Code snippet

```{r kmeans_final, include=TRUE}
# Run the algorithm
set.seed(123)
km_res <- kmeans(clustering_data_scaled, centers = 5, nstart = 25)

# Add results back to a data frame for plotting
# Note: we filter master_data the same way as clustering_data_scaled
final_results <- master_data %>%
  drop_na(GDP, CO2, Pop_Density) %>%
  mutate(Cluster = as.factor(km_res$cluster))

# Plot Clusters based on Wealth (GDP) and Emissions (CO2)
ggplot(final_results %>% filter(Year == 2022), 
       aes(x = GDP, y = CO2, color = Cluster)) +
  geom_point(aes(size = Solar), alpha = 0.6) +
  scale_x_log10() + 
  theme_minimal() +
  labs(title = "Energy Regimes: Wealth vs. Pollution (2022)",
       x = "GDP per capita (Wealth - Log Scale)",
       y = "CO2 per capita (Pollution)",
       size = "Solar Usage")
```
```{r kmeans_energy_only, include=TRUE}
# Run the algorithm on our energy variables
set.seed(123)
km_res <- kmeans(energy_only_scaled, centers = 5, nstart = 25)

# Add results back to our master table
final_results <- master_data %>%
  mutate(Cluster = as.factor(km_res$cluster))

# View distribution
table(final_results$Cluster)
```

# 6.0 Geographical Visualization (World Map)
To see the global patterns, we join our results with world map coordinates.

```{r world_map, include=TRUE}
library(maps)
world_coords <- map_data("world")

# Fix common name mismatches for the map
map_ready_data <- final_results %>%
  filter(Year == 2022) %>% # Visualizing the most recent complete year
  mutate(region = case_when(
    Entity == "United States" ~ "USA",
    Entity == "United Kingdom" ~ "UK",
    TRUE ~ Entity
  ))

# Join results with map
world_map_joined <- world_coords %>%
  left_join(map_ready_data, by = "region")

# Plot Global Map
ggplot(world_map_joined, aes(x = long, y = lat, group = group, fill = Cluster)) +
  geom_polygon(color = "white", size = 0.1) +
  scale_fill_brewer(palette = "Set1", na.value = "grey90") +
  theme_minimal() +
  labs(title = "Global Energy Regimes (2022)",
       fill = "Cluster Group") +
  theme(axis.text = element_blank(), axis.title = element_blank(), panel.grid = element_blank())
```
# 7.0 Regional Focus: Europe and Asia
We can "zoom in" on specific regions by restricting the longitude and latitude.

```{r regional_maps, include=TRUE}
# 7.1. Europe Focus
ggplot(world_map_joined, aes(x = long, y = lat, group = group, fill = Cluster)) +
  geom_polygon(color = "white", size = 0.2) +
  coord_fixed(xlim = c(-25, 45), ylim = c(34, 71), ratio = 1.3) +
  scale_fill_brewer(palette = "Set1", na.value = "grey90") +
  theme_minimal() +
  labs(title = "Energy Regimes: Europe Focus")

# 7.2. Asia Focus
ggplot(world_map_joined, aes(x = long, y = lat, group = group, fill = Cluster)) +
  geom_polygon(color = "white", size = 0.2) +
  coord_fixed(xlim = c(60, 150), ylim = c(-10, 55), ratio = 1.3) +
  scale_fill_brewer(palette = "Set1", na.value = "grey90") +
  theme_minimal() +
  labs(title = "Energy Regimes: Asia Focus")
```




